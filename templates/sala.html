<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contador de Pizza üçï</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card-pizza { transition: transform 0.2s; border: none; }
        /* Destaque visual para o cart√£o do pr√≥prio usu√°rio */
        .meu-card { border: 2px solid #dc3545; background-color: #fff5f5; }
        .badge-fatias { font-size: 1.5rem; min-width: 40px; text-align: center; display: inline-block; }
    </style>
</head>
<body class="p-3">

    <div class="container" style="max-width: 600px;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="fw-bold text-danger m-0">üçï Rod√≠zio</h1>
                <small class="text-muted">Sala: <span id="salaIdDisplay"></span></small>
            </div>
            <button onclick="compartilhar()" class="btn btn-success btn-sm">
                Zap üì≤
            </button>
        </div>

        <div id="areaCadastro" class="card p-3 shadow-sm mb-4 bg-white">
            <label class="form-label fw-bold">Vai comer tamb√©m?</label>
            <div class="input-group">
                <input type="text" id="nomeInput" class="form-control" placeholder="Seu nome">
                <button onclick="entrar()" class="btn btn-danger">Entrar na Mesa</button>
            </div>
        </div>

        <div id="listaParticipantes">
            <div class="text-center text-muted mt-5">
                <div class="spinner-border text-danger" role="status"></div>
                <p>Carregando comil√µes...</p>
            </div>
        </div>
    </div>

    <script>
        const salaId = window.location.pathname.split('/').pop();
        document.getElementById('salaIdDisplay').innerText = salaId;
        
        // Chave √∫nica para salvar o ID deste usu√°rio nesta sala espec√≠fica
        const STORAGE_KEY = 'pizza_user_id_' + salaId;
        let meuId = localStorage.getItem(STORAGE_KEY);

        // Se j√° tenho ID, escondo a caixa de cadastro imediatamente
        if (meuId) {
            document.getElementById('areaCadastro').classList.add('d-none');
        }

        function compartilhar() {
            const texto = `Acompanha o placar do rod√≠zio a√≠: ${window.location.href}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(texto)}`);
        }

        async function entrar() {
            const nome = document.getElementById('nomeInput').value;
            if (!nome) return alert("Digita um nome a√≠!");

            const res = await fetch('/api/entrar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ sala_id: salaId, nome: nome })
            });
            
            const data = await res.json();
            
            if (data.status === 'ok') {
                // Salva o ID retornado pelo servidor no navegador
                meuId = data.id;
                localStorage.setItem(STORAGE_KEY, meuId);
                
                // Esconde cadastro e atualiza lista
                document.getElementById('areaCadastro').classList.add('d-none');
                atualizarLista();
            }
        }

        async function alterarFatia(id, acao) {
            // Feedback visual imediato (Opcional, mas deixa mais r√°pido)
            atualizarLista(); 

            await fetch('/api/atualizar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: id, acao: acao })
            });
        }

        async function atualizarLista() {
            try {
                const res = await fetch(`/api/sala/${salaId}/dados`);
                const dados = await res.json();
                
                const html = dados.map(p => {
                    const souEu = (p.id === meuId);
                    
                    // Se for eu, mostro bot√µes. Se n√£o, s√≥ o n√∫mero.
                    let controles;
                    if (souEu) {
                        controles = `
                            <button onclick="alterarFatia('${p.id}', 'remove')" class="btn btn-outline-danger btn-sm rounded-circle fw-bold" style="width: 35px; height: 35px;">-</button>
                            <span class="badge-fatias text-danger fw-bold mx-2">${p.fatias}</span>
                            <button onclick="alterarFatia('${p.id}', 'add')" class="btn btn-outline-success btn-sm rounded-circle fw-bold" style="width: 35px; height: 35px;">+</button>
                        `;
                    } else {
                        controles = `
                            <span class="badge-fatias text-secondary fw-bold mx-2">${p.fatias}</span>
                            <small class="text-muted">fatias</small>
                        `;
                    }

                    return `
                        <div class="card card-pizza mb-2 shadow-sm ${souEu ? 'meu-card' : ''}">
                            <div class="card-body d-flex justify-content-between align-items-center py-3">
                                <span class="fw-bold fs-5 text-truncate" style="max-width: 50%;">${p.nome} ${souEu ? '(Voc√™)' : ''}</span>
                                <div class="d-flex align-items-center">
                                    ${controles}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                if (dados.length === 0) {
                    document.getElementById('listaParticipantes').innerHTML = '<p class="text-center text-muted mt-4">Ningu√©m na mesa ainda...</p>';
                } else {
                    document.getElementById('listaParticipantes').innerHTML = html;
                }
            } catch (e) {
                console.error("Erro ao atualizar", e);
            }
        }

        // Atualiza a cada 2 segundos
        setInterval(atualizarLista, 2000);
        atualizarLista();
    </script>
</body>
</html>